# Hazelcast CP数据结构指南

## 什么是CP数据结构

在分布式系统中，CAP定理指出系统不能同时满足一致性(Consistency)、可用性(Availability)和分区容忍性(Partition tolerance)这三个特性。CP数据结构选择优先保证一致性(C)和分区容忍性(P)，在网络分区发生时可能会牺牲部分可用性。

CP数据结构遵循类似于共识算法（如Raft）的机制，确保数据在所有节点间的一致性。这使得CP数据结构更适合于需要强一致性保证的场景，如分布式锁、分布式计数器等。

## Hazelcast的CP数据结构

Hazelcast提供了以下CP数据结构，每一种都针对需要强一致性保证的特定场景进行了优化：

### 1. CPMap

**定义：** 提供线性一致性保证的分布式Map实现。

**主要特性：**
- 线性一致性（强一致性）
- 基于Raft共识算法
- 支持原子操作
- 透明的失败恢复

**适用场景：**
- 需要强一致性的配置存储
- 分布式状态管理
- 关键业务数据存储

### 2. FencedLock

**定义：** 分布式重入锁实现，提供基于栅栏token的保护机制。

**主要特性：**
- 防止脑裂问题
- 支持可重入锁定
- 提供栅栏令牌机制
- 支持锁定获取等待时间

**适用场景：**
- 分布式互斥访问控制
- 领导者选举
- 防止并发访问共享资源

### 3. IAtomicLong

**定义：** 分布式原子长整数，提供线性一致性保证的数值操作。

**主要特性：**
- 原子递增/递减
- 比较并设置操作
- 线性一致性保证

**适用场景：**
- 分布式计数器
- 序列号生成
- 需要原子性的统计

### 4. IAtomicReference

**定义：** 分布式原子引用，提供线性一致性保证的对象引用操作。

**主要特性：**
- 原子更新引用
- 比较并交换操作
- 线性一致性保证

**适用场景：**
- 分布式共享状态
- 原子对象更新
- 单一领导者选举

### 5. ICountDownLatch

**定义：** 分布式倒计时锁，类似于Java的CountDownLatch。

**主要特性：**
- 允许一个或多个线程等待一组操作完成
- 支持分布式协调
- 线性一致性保证

**适用场景：**
- 分布式系统启动协调
- 任务完成同步
- 分布式屏障

### 6. ISemaphore

**定义：** 分布式信号量，控制对资源的并发访问。

**主要特性：**
- 控制并发访问数量
- 支持获取和释放权限
- 支持公平和非公平模式

**适用场景：**
- 资源池访问控制
- 限流
- 并发任务调度

## CP子系统架构

Hazelcast的CP子系统基于Raft共识算法实现，具有以下关键特点：

1. **CP组**：由奇数个成员组成的逻辑分组，通过多数表决提供一致性
2. **会话机制**：跟踪客户端会话状态，处理故障转移
3. **领导者选举**：通过Raft算法选出领导者，处理写入请求
4. **日志复制**：通过复制日志确保一致性
5. **快照**：定期创建快照提高性能

## CP与AP数据结构对比

| 特性 | CP数据结构 | AP数据结构 |
|------|-----------|-----------|
| 一致性保证 | 强一致性（线性一致性） | 最终一致性 |
| 网络分区时行为 | 可能拒绝服务以保证一致性 | 继续提供服务，接受临时不一致 |
| 性能 | 写入性能较低（需共识） | 写入性能较高 |
| 扩展性 | 受CP组大小限制 | 更容易水平扩展 |
| 适用场景 | 需要强一致性的关键操作 | 高可用性，可接受最终一致性 |

## 如何选择CP数据结构

在选择CP数据结构时，需要考虑以下因素：

1. **一致性要求**：如果应用需要强一致性保证，CP数据结构是必选
2. **容错特性**：了解CP数据结构在网络分区时的行为
3. **性能需求**：CP操作通常需要多数节点确认，性能较低
4. **高可用性需求**：在某些网络分区情况下，CP结构可能不可用

## CP子系统配置

配置CP子系统时需要注意以下几点：

1. **CP成员数量**：推荐3、5或7个成员（始终使用奇数）
2. **会话超时**：根据网络条件和工作负载调整
3. **失败检测器**：配置适当的超时和阈值
4. **持久化**：考虑启用持久化提高故障恢复能力

## 最佳实践

- 仅在真正需要强一致性时使用CP数据结构
- 混合使用CP和AP数据结构，根据不同数据的要求选择
- 配置适当数量的CP成员（通常为3或5）
- 确保CP组中的奇数个成员，避免脑裂问题
- 监控CP子系统的健康状态
- 适当配置会话超时，平衡可用性和资源回收
- 考虑为关键CP数据结构启用持久化
- 测试系统在各种故障场景下的行为 