# Hazelcast数据结构全景图

## 概述

Hazelcast作为一个分布式内存数据网格，提供了丰富的数据结构集合，这些数据结构根据CAP定理可以分为两大类：AP数据结构和CP数据结构。本文档提供了对Hazelcast所有主要数据结构的综合概览，帮助开发者快速理解并选择适合其应用场景的数据结构。

## 数据结构分类

### AP数据结构（优先保证可用性和分区容忍性）

AP数据结构在网络分区发生时，优先保证系统的可用性，可能会导致短暂的数据不一致，但最终会达到一致状态。

1. **Map (IMap)**
   - 分布式键值存储
   - 支持多种事件监听器
   - 提供丰富的查询能力
   - 支持数据持久化

2. **MultiMap**
   - 支持一个键对应多个值
   - 适合多值关联场景
   - 支持监听器和查询

3. **ReplicatedMap**
   - 数据自动复制到所有节点
   - 读操作极快（本地读取）
   - 适合读多写少场景

4. **Set**
   - 不允许重复元素
   - 支持标准集合操作
   - 可配置备份策略

5. **List**
   - 有序集合，支持索引访问
   - 允许重复元素
   - 提供位置相关操作

6. **Queue**
   - 先进先出数据结构
   - 支持阻塞操作
   - 适合任务分发场景

7. **Ringbuffer**
   - 固定大小的循环缓冲区
   - 高效的生产者-消费者模式
   - 支持批量读写

8. **Topic**
   - 发布-订阅消息传递
   - 支持可靠消息传递
   - 处理消息广播

9. **Cache**
   - JCache API实现
   - 支持各种驱逐策略
   - 适合缓存场景

10. **Flake ID Generator**
    - 分布式唯一ID生成
    - 高性能，每秒百万级ID
    - 具有顺序性和唯一性

11. **PN Counter**
    - 分布式计数器
    - 支持增加和减少操作
    - 处理网络分区下的冲突解决

### CP数据结构（优先保证一致性和分区容忍性）

CP数据结构在网络分区发生时，优先保证数据一致性，可能会牺牲部分可用性。这些数据结构基于Raft共识算法实现。

1. **CPMap**
   - 强一致性的分布式映射
   - 基于Raft共识
   - 适合配置存储

2. **FencedLock**
   - 分布式可重入锁
   - 防止脑裂问题
   - 适合互斥访问控制

3. **IAtomicLong**
   - 原子长整数
   - 支持线性一致性操作
   - 适合分布式计数器

4. **IAtomicReference**
   - 原子引用
   - 支持比较并交换
   - 适合共享状态管理

5. **ICountDownLatch**
   - 分布式倒计时锁
   - 支持分布式协调
   - 适合任务完成同步

6. **ISemaphore**
   - 分布式信号量
   - 控制资源并发访问
   - 适合限流场景

## 选择指南

### 何时选择AP数据结构

- 业务场景可以接受短暂的数据不一致
- 需要高吞吐量和低延迟
- 系统要求高可用性，即使在网络分区时
- 读操作频繁于写操作
- 数据量大，需要良好的水平扩展能力

### 何时选择CP数据结构

- 业务场景需要强一致性保证
- 需要分布式协调和同步
- 操作需要严格的线性一致性
- 可以容忍在网络分区时可能的服务中断
- 数据量相对较小，更关注正确性而非吞吐量

## 性能考量

### AP数据结构性能特点

- 读写操作通常较快（特别是本地缓存命中时）
- 扩展性好，可以通过增加节点线性提升性能
- 写操作可能涉及备份复制，但不需要多数确认
- 读操作可以从本地副本快速返回

### CP数据结构性能特点

- 写操作需要多数节点确认，延迟较高
- 读操作可能需要与领导者节点通信
- 吞吐量受限于CP组的大小和网络条件
- 扩展性受限，增加节点不一定提升性能

## 最佳实践

1. **混合使用策略**
   - 在同一应用中混合使用AP和CP数据结构
   - 根据每种数据的一致性需求选择合适的数据结构

2. **分区策略**
   - 为AP数据结构配置适当的分区数
   - 分区数通常应大于集群节点数

3. **备份配置**
   - 为AP数据结构配置适当的备份数量
   - 平衡数据安全性和性能

4. **CP组配置**
   - 使用奇数个CP成员（通常3或5个）
   - 适当配置会话超时和操作超时

5. **监控与管理**
   - 监控分区分布和迁移
   - 关注内存使用和存储策略
   - 定期检查集群健康状态

## 结论

Hazelcast提供的丰富数据结构满足了不同的分布式计算需求。通过理解AP和CP数据结构的特性和适用场景，开发者可以为其应用选择最合适的数据结构，实现理想的性能、可用性和一致性平衡。

在实际应用中，往往需要将不同类型的数据结构组合使用，这样能够充分利用Hazelcast的分布式计算能力，构建健壮、高效的分布式应用。 